<!DOCTYPE html>
<html lang="it">
<head>
    <script src="/js/head-common.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Zone OMI Roma - Canone Concordato 2025</title>
    <meta name="description" content="Trova la tua zona OMI a Roma e scopri quanto puoi affittare a canone concordato. Mappa interattiva con 233 microzone e valori €/mq aggiornati 2025.">
    <link rel="canonical" href="https://bonusimmobiliare.it/mappe/roma/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Mappa Zone OMI Roma - Canone Concordato 2025">
    <meta property="og:description" content="Trova la tua zona OMI a Roma e scopri quanto puoi affittare a canone concordato.">
    <meta property="og:url" content="https://bonusimmobiliare.it/mappe/roma/">
    <meta property="og:image" content="https://bonusimmobiliare.it/og-image.jpg">
    <meta property="og:site_name" content="Bonus Immobiliare">
    <meta property="og:locale" content="it_IT">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700;1,9..144,400;1,9..144,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400;1,8..60,500&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- ═══════════════════════════════════════════════════════════════
         TEMPLATE CONFIG - Modifica queste variabili per altre città
    ═══════════════════════════════════════════════════════════════ -->
    <script>
        const CITY_CONFIG = {
            name: 'Roma',
            slug: 'roma',
            geojsonPath: '/data/roma_omi_zones.geojson',
            zoneDataPath: '/data/roma-zone-omi.json',
            center: [41.9028, 12.4964],
            bounds: [[41.655, 12.035], [42.145, 12.855]],
            zoom: 11,
            dokicasaUrl: 'https://app.dokicasa.it/contratti/foglio-caratteristiche-immobile-roma/crea/default?utm_source=bonusimmobiliare&utm_medium=mappa&utm_campaign=roma',
            totalZones: 233,
            accordoYear: 2023,
            accordoDate: '7 agosto 2023'
        };
    </script>

    <style>
        /* ═══════════════════════════════════════════════════════════════
           DESIGN SYSTEM - BONUS IMMOBILIARE
           Warm Editorial Aesthetic
        ═══════════════════════════════════════════════════════════════ */

        :root {
            /* Primary Palette - Olive Family */
            --olive: #5C6B4A;
            --olive-deep: #3D4832;
            --olive-dark: #2A3223;
            --olive-light: #7A8A68;
            --sage: #8A9A78;
            --sage-pale: #D4DEC9;
            --sage-mist: #E8EEE0;

            /* Warm Neutrals */
            --cream: #FAF7F2;
            --cream-dark: #F2EDE4;
            --parchment: #EDE7DB;
            --stone: #DAD7CD;
            --earth: #8B8178;
            --bark: #4A3F35;

            /* Accent Colors */
            --terracotta: #F06543;
            --terracotta-light: #F4846A;
            --terracotta-pale: #F5E6DF;
            --gold: #BFA67A;
            --gold-light: #D4C4A0;
            --gold-pale: #F5F0E5;

            /* Zone Colors - Vivid warm palette */
            --zone-b: #E85D3B;  /* Centrale - Terracotta vivace */
            --zone-c: #F09B47;  /* Semicentrale - Arancio brillante */
            --zone-d: #E8C44A;  /* Periferica - Giallo oro */
            --zone-e: #6BAF7A;  /* Suburbana - Verde fresco */
            --zone-r: #7BA08A;  /* Rurale - Verde salvia */

            /* Typography */
            --font-display: 'Fraunces', Georgia, serif;
            --font-body: 'Source Serif 4', Georgia, serif;

            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;

            /* Border Radius */
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --radius-xl: 2rem;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-soft: 0 2px 20px rgba(74, 63, 53, 0.06);
            --shadow-medium: 0 4px 30px rgba(74, 63, 53, 0.1);
            --shadow-lifted: 0 12px 40px rgba(74, 63, 53, 0.12);

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
        }

        /* ═══════════════════════════════════════════════════════════════
           BASE RESET
        ═══════════════════════════════════════════════════════════════ */

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--cream);
            color: var(--bark);
            line-height: 1.6;
            font-size: 1rem;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 500;
            line-height: 1.2;
            color: var(--olive-deep);
        }

        a {
            color: inherit;
            text-decoration: none;
        }


        /* ═══════════════════════════════════════════════════════════════
           HEADER BAR - Ultra compatto, editoriale
        ═══════════════════════════════════════════════════════════════ */

        .header-bar {
            background: var(--cream);
            padding: var(--space-sm) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-lg);
            border-bottom: 2px solid var(--terracotta);
            position: relative;
            z-index: 100;
        }

        .header-logo img {
            height: 32px;
            width: auto;
            display: block;
        }

        .header-title {
            flex: 1;
            text-align: center;
        }

        .header-title h1 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--olive-deep);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .header-title h1 span {
            color: var(--terracotta);
        }

        .header-back {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--olive);
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .header-back:hover {
            color: var(--terracotta);
        }

        .header-back svg {
            width: 14px;
            height: 14px;
        }

        /* ═══════════════════════════════════════════════════════════════
           MAIN LAYOUT - Map + Sidebar
        ═══════════════════════════════════════════════════════════════ */

        .main-content {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .map-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--parchment);
            min-width: 0;
        }

        #map {
            flex: 1;
            min-height: 400px;
            z-index: 1;
        }

        /* ═══════════════════════════════════════════════════════════════
           SEARCH BAR
        ═══════════════════════════════════════════════════════════════ */

        .search-container {
            position: absolute;
            top: var(--space-lg);
            left: 60px; /* Spazio per i controlli zoom */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        /* Leaflet zoom controls styling */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: var(--shadow-medium) !important;
        }

        .leaflet-control-zoom a {
            background: white !important;
            color: var(--olive-deep) !important;
            border: none !important;
            width: 32px !important;
            height: 32px !important;
            line-height: 32px !important;
            font-size: 16px !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--cream) !important;
            color: var(--terracotta) !important;
        }

        .leaflet-control-zoom-in {
            border-radius: var(--radius-sm) var(--radius-sm) 0 0 !important;
        }

        .leaflet-control-zoom-out {
            border-radius: 0 0 var(--radius-sm) var(--radius-sm) !important;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            font-family: var(--font-body);
            padding: var(--space-md) var(--space-lg) var(--space-md) 48px;
            font-size: 0.95rem;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            width: 340px;
            max-width: calc(100vw - 100px);
            outline: none;
            background: white;
            color: var(--bark);
            box-shadow: var(--shadow-lifted);
            transition: var(--transition-base);
        }

        .search-box input::placeholder {
            color: var(--earth);
        }

        .search-box input:focus {
            border-color: var(--terracotta);
            box-shadow: var(--shadow-lifted), 0 0 0 3px rgba(240, 101, 67, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--terracotta);
        }

        .search-results {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lifted);
            max-height: 280px;
            overflow-y: auto;
            display: none;
            position: relative;
            z-index: 1001;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            border-bottom: 1px solid var(--stone);
            font-size: 0.9rem;
            transition: var(--transition-fast);
            color: var(--bark);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--sage-mist);
        }

        .search-loading {
            padding: var(--space-lg);
            text-align: center;
            color: var(--earth);
            font-size: 0.9rem;
        }

        .search-rate-limit {
            color: var(--terracotta);
            font-size: 0.85rem;
        }

        /* ═══════════════════════════════════════════════════════════════
           LEGEND
        ═══════════════════════════════════════════════════════════════ */

        .legend {
            position: absolute;
            bottom: var(--space-xl);
            left: var(--space-lg);
            z-index: 1000;
            background: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lifted);
            border-left: 4px solid var(--terracotta);
        }

        .legend-title {
            font-family: var(--font-display);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--olive-deep);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: var(--space-xs) 0;
            font-size: 0.8rem;
            color: var(--bark);
        }

        .legend-color {
            width: 24px;
            height: 14px;
            margin-right: var(--space-sm);
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* ═══════════════════════════════════════════════════════════════
           SIDEBAR (Fixed Right) - Compact Wide Layout
        ═══════════════════════════════════════════════════════════════ */

        .sidebar {
            width: 420px;
            background: white;
            border-left: 1px solid var(--stone);
            display: flex;
            flex-direction: column;
        }

        .sidebar-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            text-align: center;
            color: var(--earth);
        }

        .sidebar-placeholder-icon {
            width: 40px;
            height: 40px;
            margin-bottom: var(--space-sm);
            opacity: 0.4;
        }

        .sidebar-placeholder p {
            font-size: 0.85rem;
            margin: 0;
            max-width: 280px;
        }

        .sidebar-content {
            display: none;
            flex-direction: column;
        }

        .sidebar-content.visible {
            display: flex;
        }

        /* Header: Zona code + type + name */
        .sidebar-header {
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, var(--cream) 0%, var(--sage-mist) 100%);
            border-bottom: 2px solid var(--terracotta);
        }

        .sidebar-zona-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .sidebar-zona-code {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        .sidebar-zona-type {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 2px var(--space-sm);
            border-radius: var(--radius-sm);
            font-weight: 600;
            color: white;
        }

        .sidebar-zona-name {
            font-size: 0.8rem;
            color: var(--earth);
            margin-top: 2px;
        }

        /* Body: Grid layout for compactness */
        .sidebar-body {
            padding: var(--space-md) var(--space-lg);
        }

        /* Range - prominent */
        .sidebar-range-section {
            background: linear-gradient(135deg, var(--terracotta-pale) 0%, var(--gold-pale) 100%);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            text-align: center;
            border: 1px solid rgba(240, 101, 67, 0.15);
            margin-bottom: var(--space-md);
        }

        .sidebar-range-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--terracotta);
            font-weight: 600;
        }

        .sidebar-range-value {
            font-family: var(--font-display);
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--bark);
        }

        .sidebar-range-unit {
            font-size: 0.7rem;
            color: var(--earth);
        }

        /* Two column grid for fasce + examples */
        .sidebar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
        }

        .sidebar-section {
            background: var(--cream);
            border-radius: var(--radius-sm);
            padding: var(--space-sm) var(--space-md);
        }

        .sidebar-section-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--olive);
            margin-bottom: var(--space-sm);
            font-weight: 600;
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--stone);
        }

        .sidebar-fasce {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-fascia-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-fascia-label {
            color: var(--earth);
            font-size: 0.75rem;
        }

        .sidebar-fascia-value {
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--bark);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Examples */
        .sidebar-examples {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .sidebar-example {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-example-label {
            color: var(--olive-deep);
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .sidebar-example-label small {
            display: block;
            color: var(--earth);
            font-size: 0.6rem;
            margin-top: 1px;
        }

        .sidebar-example-value {
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--bark);
            font-size: 0.8rem;
            white-space: nowrap;
            text-align: right;
        }

        /* Note for rural zones */
        .sidebar-note-section {
            margin-bottom: var(--space-md);
        }

        .sidebar-note {
            padding: var(--space-sm);
            background: var(--gold-pale);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--bark);
            border-left: 3px solid var(--gold);
        }

        /* Footer with CTA - NO border-top, clean transition */
        .sidebar-footer {
            padding: var(--space-md) var(--space-lg);
            background: white;
            margin-top: auto;
        }

        .sidebar-cta {
            display: block;
            background: var(--terracotta);
            color: white;
            text-align: center;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition-base);
            box-shadow: 0 2px 8px rgba(240, 101, 67, 0.2);
        }

        .sidebar-cta:hover {
            background: var(--terracotta-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 101, 67, 0.35);
        }

        /* ═══════════════════════════════════════════════════════════════
           LEAFLET CUSTOM STYLES
        ═══════════════════════════════════════════════════════════════ */

        /* Leaflet Popup - Minimal tooltip style */
        .leaflet-popup-content-wrapper {
            background: var(--olive-deep);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-medium);
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            font-family: var(--font-display);
            color: white;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .leaflet-popup-tip {
            background: var(--olive-deep);
        }

        .leaflet-popup-close-button {
            display: none;
        }

        /* Zone tooltip - minimal */
        .zone-tooltip {
            background: var(--olive-deep) !important;
            border: none !important;
            border-radius: 4px !important;
            color: white !important;
            font-family: var(--font-display) !important;
            font-weight: 600 !important;
            font-size: 0.8rem !important;
            padding: 4px 8px !important;
            box-shadow: var(--shadow-soft) !important;
        }

        .zone-tooltip::before {
            display: none !important;
        }

        /* Address Marker */
        .address-marker {
            background: var(--terracotta);
            border: 3px solid var(--cream);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            box-shadow: 0 2px 8px rgba(240, 101, 67, 0.5);
        }

        /* ═══════════════════════════════════════════════════════════════
           FOOTER
        ═══════════════════════════════════════════════════════════════ */

        .footer-mini {
            background: var(--olive-deep);
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
            border-top: 3px solid var(--terracotta);
        }

        .footer-mini-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .footer-mini-text a {
            color: var(--gold-light);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .footer-mini-text a:hover {
            color: var(--gold);
        }

        .footer-mini-source {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ═══════════════════════════════════════════════════════════════
           RESPONSIVE
        ═══════════════════════════════════════════════════════════════ */

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .map-wrapper {
                min-height: 50vh;
            }

            .sidebar {
                width: 100%;
                max-height: none;
                border-left: none;
                border-top: 2px solid var(--terracotta);
                overflow-y: auto;
            }

            .sidebar-placeholder {
                padding: var(--space-lg);
            }

            .sidebar-body {
                padding: var(--space-sm) var(--space-md);
            }

            .sidebar-footer {
                padding: var(--space-sm) var(--space-md);
            }
        }

        @media (max-width: 768px) {
            .header-bar {
                padding: var(--space-sm) var(--space-md);
            }

            .header-logo img {
                height: 26px;
            }

            .header-title h1 {
                font-size: 0.85rem;
            }

            .header-back span {
                display: none;
            }

            .search-container {
                top: var(--space-md);
                left: var(--space-md);
                right: auto;
            }

            .search-box input {
                width: calc(100vw - 80px);
                max-width: 300px;
                padding: var(--space-sm) var(--space-md) var(--space-sm) 40px;
                font-size: 0.85rem;
            }

            .search-icon {
                width: 16px;
                height: 16px;
                left: var(--space-sm);
            }

            /* Nascondi legenda su mobile */
            .legend {
                display: none;
            }

            .sidebar-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-xs);
            }

            .sidebar-section {
                padding: var(--space-xs) var(--space-sm);
            }

            .sidebar-section-title {
                font-size: 0.6rem;
                margin-bottom: var(--space-xs);
            }

            .sidebar-range-section {
                padding: var(--space-xs) var(--space-sm);
                margin-bottom: var(--space-sm);
            }

            .sidebar-range-value {
                font-size: 1.1rem;
            }

            .sidebar-cta {
                padding: var(--space-sm);
                font-size: 0.85rem;
            }

            .footer-mini {
                flex-direction: column;
                text-align: center;
                padding: var(--space-md);
            }

            .footer-mini-text {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .header-title h1 {
                font-size: 0.75rem;
            }

            .sidebar-grid {
                grid-template-columns: 1fr;
            }

            .search-box input {
                width: calc(100vw - 32px);
            }
        }
    </style>
</head>
<body>
    <!-- Header Compatto -->
    <header class="header-bar">
        <a href="/" class="header-logo">
            <img src="/logo/logo_light_bg.svg" alt="Bonus Immobiliare">
        </a>
        <div class="header-title">
            <h1>Mappa Zone OMI <span id="city-name">Roma</span></h1>
        </div>
        <a href="/" class="header-back">
            <span>Torna al sito</span>
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
        </a>
    </header>

    <!-- Main Content: Map + Sidebar -->
    <div class="main-content">
        <!-- Map -->
        <div class="map-wrapper">
            <div id="map"></div>

            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="address-search" placeholder="Cerca indirizzo a Roma..." aria-label="Cerca indirizzo a Roma">
                </div>
                <div class="search-results" id="search-results"></div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Tipologia Zone</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-b);"></div> B - Centrale</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-c);"></div> C - Semicentrale</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-d);"></div> D - Periferica</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-e);"></div> E - Suburbana</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-r);"></div> R - Rurale</div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Placeholder when no zone selected -->
            <div class="sidebar-placeholder" id="sidebar-placeholder">
                <svg class="sidebar-placeholder-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                </svg>
                <p>Clicca su una zona della mappa o cerca un indirizzo per vedere i dettagli del canone concordato.</p>
            </div>

            <!-- Content when zone selected -->
            <div class="sidebar-content" id="sidebar-content">
                <div class="sidebar-header">
                    <div class="sidebar-zona-row">
                        <span class="sidebar-zona-code" id="sidebar-code">B1</span>
                        <span class="sidebar-zona-type" id="sidebar-type">Centrale</span>
                    </div>
                    <div class="sidebar-zona-name" id="sidebar-name">Testaccio (Piazza S. Maria Liberatrice)</div>
                </div>

                <div class="sidebar-body">
                    <!-- Range -->
                    <div class="sidebar-range-section">
                        <div class="sidebar-range-label">Range Canone Concordato</div>
                        <div class="sidebar-range-value" id="sidebar-range">10,45 - 17,70</div>
                        <div class="sidebar-range-unit">euro/mq/mese</div>
                    </div>

                    <!-- Two column grid: Fasce + Esempi -->
                    <div class="sidebar-grid">
                        <!-- Fasce -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Fasce €/mq</div>
                            <div class="sidebar-fasce">
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">A (base)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-a">10,45-13,35</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">B (media)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-b">13,36-15,50</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">C (alta)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-c">15,51-17,70</span>
                                </div>
                            </div>
                        </div>

                        <!-- Esempi Affitto -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Esempi Mensili</div>
                            <div class="sidebar-examples">
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Camera<small>18mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-camera">188-319€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Bilocale<small>50mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-bilocale">523-885€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Trilocale<small>100mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-trilocale">1.045-1.770€</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Note (for rural zones) -->
                    <div class="sidebar-note-section" id="sidebar-note-section" style="display: none;">
                        <div class="sidebar-note" id="sidebar-note"></div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <a href="#" class="sidebar-cta" id="sidebar-cta" target="_blank" rel="noopener">
                        Calcola il Canone Esatto &rarr;
                    </a>
                </div>
            </div>
        </aside>
    </div>

    <!-- Footer Mini -->
    <footer class="footer-mini">
        <div class="footer-mini-text">
            Dati: <a href="https://www.agenziaentrate.gov.it/portale/web/guest/schede/fabbricatiterreni/omi/banche-dati/quotazioni-immobiliari" target="_blank" rel="noopener">Agenzia delle Entrate - OMI</a> |
            Valori: <a href="/blog/canone-concordato-roma/" rel="noopener">Accordo Territoriale Roma</a>
        </div>
        <div class="footer-mini-source">
            © 2025 Bonus Immobiliare
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script>
        // ═══════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════

        // Update page content from config
        document.getElementById('city-name').textContent = CITY_CONFIG.name;
        document.getElementById('address-search').placeholder = `Cerca indirizzo a ${CITY_CONFIG.name}...`;
        document.getElementById('sidebar-cta').href = CITY_CONFIG.dokicasaUrl;

        // Zone data storage
        let zoneData = {};

        // ═══════════════════════════════════════════════════════════════
        // COLORS AND UTILITIES
        // ═══════════════════════════════════════════════════════════════

        function getColor(codzona) {
            if (!codzona) return '#8B8178';
            const prefix = codzona.charAt(0).toUpperCase();
            const colors = {
                'B': getComputedStyle(document.documentElement).getPropertyValue('--zone-b').trim(),
                'C': getComputedStyle(document.documentElement).getPropertyValue('--zone-c').trim(),
                'D': getComputedStyle(document.documentElement).getPropertyValue('--zone-d').trim(),
                'E': getComputedStyle(document.documentElement).getPropertyValue('--zone-e').trim(),
                'R': getComputedStyle(document.documentElement).getPropertyValue('--zone-r').trim()
            };
            return colors[prefix] || '#8B8178';
        }

        function getTipoZona(codzona) {
            if (!codzona) return 'Non classificata';
            const prefix = codzona.charAt(0).toUpperCase();
            const types = {
                'B': 'Centrale',
                'C': 'Semicentrale',
                'D': 'Periferica',
                'E': 'Suburbana',
                'R': 'Rurale'
            };
            return types[prefix] || 'Altra';
        }

        function formatPrice(value) {
            if (value === null || value === undefined) return 'N/D';
            return value.toFixed(2).replace('.', ',');
        }

        // Convert UPPERCASE to Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/(?:^|\s|[-(])\w/g, function(match) {
                return match.toUpperCase();
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // MAP SETUP
        // ═══════════════════════════════════════════════════════════════

        const romaBounds = L.latLngBounds(CITY_CONFIG.bounds[0], CITY_CONFIG.bounds[1]);

        const map = L.map('map', {
            center: CITY_CONFIG.center,
            zoom: CITY_CONFIG.zoom,
            minZoom: 10,
            maxZoom: 18,
            maxBounds: romaBounds,
            maxBoundsViscosity: 1.0
        });

        // Close tooltips during drag to prevent accumulation
        map.on('dragstart', function() {
            map.eachLayer(function(layer) {
                if (layer.getTooltip && layer.getTooltip()) {
                    layer.closeTooltip();
                }
            });
        });

        // CartoDB Positron - clean, editorial look
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // ═══════════════════════════════════════════════════════════════
        // GEOJSON LAYER
        // ═══════════════════════════════════════════════════════════════

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.CODZONA),
                weight: 1,
                opacity: 1,
                color: 'rgba(255,255,255,0.8)',
                fillOpacity: 0.55
            };
        }

        let lastHighlighted = null;
        let geojsonLayer;
        let addressMarker = null;

        function closeAllTooltips() {
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    layer.closeTooltip();
                });
            }
        }

        function highlightFeature(e) {
            // Close all tooltips first to prevent accumulation
            closeAllTooltips();

            if (lastHighlighted && lastHighlighted !== e.target) {
                geojsonLayer.resetStyle(lastHighlighted);
            }
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#2A3223',
                fillOpacity: 0.8
            });
            layer.bringToFront();
            lastHighlighted = layer;
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            if (lastHighlighted === e.target) {
                lastHighlighted = null;
            }
        }

        function showSidebar(codzona) {
            const placeholder = document.getElementById('sidebar-placeholder');
            const content = document.getElementById('sidebar-content');
            const data = zoneData[codzona];

            if (!data) {
                placeholder.style.display = 'flex';
                content.classList.remove('visible');
                return;
            }

            // Hide placeholder, show content
            placeholder.style.display = 'none';
            content.classList.add('visible');

            // Update sidebar content
            document.getElementById('sidebar-code').textContent = codzona;
            document.getElementById('sidebar-type').textContent = getTipoZona(codzona);
            document.getElementById('sidebar-type').style.background = getColor(codzona);
            document.getElementById('sidebar-name').textContent = toTitleCase(data.nome || '');

            // Range
            if (data.min !== null && data.max !== null) {
                document.getElementById('sidebar-range').textContent = `${formatPrice(data.min)} - ${formatPrice(data.max)}`;

                // Calcola esempi affitto
                const cameraMin = Math.round(data.min * 18);
                const cameraMax = Math.round(data.max * 18);
                const bilocaleMin = Math.round(data.min * 50);
                const bilocaleMax = Math.round(data.max * 50);
                const trilocaleMin = Math.round(data.min * 100);
                const trilocaleMax = Math.round(data.max * 100);

                document.getElementById('sidebar-ex-camera').textContent = `${cameraMin.toLocaleString('it')} - ${cameraMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-bilocale').textContent = `${bilocaleMin.toLocaleString('it')} - ${bilocaleMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-trilocale').textContent = `${trilocaleMin.toLocaleString('it')} - ${trilocaleMax.toLocaleString('it')} €`;
            } else {
                document.getElementById('sidebar-range').textContent = 'N/D';
                document.getElementById('sidebar-ex-camera').textContent = 'N/D';
                document.getElementById('sidebar-ex-bilocale').textContent = 'N/D';
                document.getElementById('sidebar-ex-trilocale').textContent = 'N/D';
            }

            // Fasce (compact format)
            if (data.fasce) {
                document.getElementById('sidebar-fascia-a').textContent = data.fasce.A ?
                    `${formatPrice(data.fasce.A.min)}-${formatPrice(data.fasce.A.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-b').textContent = data.fasce.B ?
                    `${formatPrice(data.fasce.B.min)}-${formatPrice(data.fasce.B.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-c').textContent = data.fasce.C ?
                    `${formatPrice(data.fasce.C.min)}-${formatPrice(data.fasce.C.max)}` : 'N/D';
            }

            // Note (for rural zones)
            const noteSection = document.getElementById('sidebar-note-section');
            const noteEl = document.getElementById('sidebar-note');
            if (data.note) {
                noteEl.textContent = data.note;
                noteSection.style.display = 'block';
            } else {
                noteSection.style.display = 'none';
            }
        }

        function onEachFeature(feature, layer) {
            // Bind minimal tooltip
            const codzona = feature.properties.CODZONA;
            if (codzona) {
                layer.bindTooltip(codzona, {
                    permanent: false,
                    direction: 'center',
                    className: 'zone-tooltip'
                });
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    showSidebar(codzona);
                }
            });
        }

        // Load zone data first, then GeoJSON
        fetch(CITY_CONFIG.zoneDataPath)
            .then(response => response.json())
            .then(data => {
                zoneData = data;
                return fetch(CITY_CONFIG.geojsonPath);
            })
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                const bounds = geojsonLayer.getBounds();
                map.fitBounds(bounds);
                map.setMaxBounds(bounds.pad(0.1));
            })
            .catch(err => {
                console.error('Errore caricamento dati:', err);
            });

        // ═══════════════════════════════════════════════════════════════
        // ADDRESS SEARCH (Nominatim Geocoding with Rate Limiting)
        // ═══════════════════════════════════════════════════════════════

        const addressInput = document.getElementById('address-search');
        const searchResults = document.getElementById('search-results');
        let searchTimeout = null;
        let lastSearchTime = 0;
        const RATE_LIMIT_MS = 10000; // 10 seconds

        addressInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query.length < 3) {
                searchResults.classList.remove('visible');
                return;
            }

            // Check rate limit
            const now = Date.now();
            const timeSinceLastSearch = now - lastSearchTime;

            if (timeSinceLastSearch < RATE_LIMIT_MS && lastSearchTime > 0) {
                const waitSeconds = Math.ceil((RATE_LIMIT_MS - timeSinceLastSearch) / 1000);
                searchResults.innerHTML = `<div class="search-loading search-rate-limit">Attendi ${waitSeconds} secondi prima della prossima ricerca</div>`;
                searchResults.classList.add('visible');

                // Auto-retry after the wait time
                searchTimeout = setTimeout(() => searchAddress(query), RATE_LIMIT_MS - timeSinceLastSearch + 100);
                return;
            }

            searchTimeout = setTimeout(() => searchAddress(query), 400);
        });

        async function searchAddress(query) {
            const now = Date.now();
            const timeSinceLastSearch = now - lastSearchTime;

            if (timeSinceLastSearch < RATE_LIMIT_MS && lastSearchTime > 0) {
                const waitSeconds = Math.ceil((RATE_LIMIT_MS - timeSinceLastSearch) / 1000);
                searchResults.innerHTML = `<div class="search-loading search-rate-limit">Attendi ${waitSeconds} secondi</div>`;
                searchResults.classList.add('visible');
                return;
            }

            searchResults.innerHTML = '<div class="search-loading">Ricerca in corso...</div>';
            searchResults.classList.add('visible');

            try {
                lastSearchTime = Date.now();

                const viewbox = `${CITY_CONFIG.bounds[0][1]},${CITY_CONFIG.bounds[1][0]},${CITY_CONFIG.bounds[1][1]},${CITY_CONFIG.bounds[0][0]}`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', ' + CITY_CONFIG.name + ', Italia')}&limit=5&addressdetails=1&viewbox=${viewbox}&bounded=1`;

                const response = await fetch(url, {
                    headers: { 'Accept-Language': 'it' }
                });
                const results = await response.json();

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-loading">Nessun risultato trovato</div>';
                    return;
                }

                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lon="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');

                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        goToAddress(parseFloat(this.dataset.lat), parseFloat(this.dataset.lon), this.textContent.trim());
                    });
                });
            } catch (err) {
                searchResults.innerHTML = '<div class="search-loading">Errore nella ricerca. Riprova tra qualche secondo.</div>';
            }
        }

        function goToAddress(lat, lon, name) {
            if (addressMarker) map.removeLayer(addressMarker);

            const markerIcon = L.divIcon({
                className: 'address-marker',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });

            addressMarker = L.marker([lat, lon], { icon: markerIcon })
                .addTo(map);

            map.setView([lat, lon], 16);

            // Find containing zone
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.getBounds && layer.getBounds().contains([lat, lon])) {
                        const point = L.latLng(lat, lon);
                        if (isPointInPolygon(point, layer)) {
                            highlightFeature({ target: layer });
                            const props = layer.feature.properties;
                            showSidebar(props.CODZONA);
                        }
                    }
                });
            }

            searchResults.classList.remove('visible');
            addressInput.value = '';
        }

        function isPointInPolygon(point, layer) {
            if (layer.feature.geometry.type === 'Polygon') {
                return isPointInPath(point, layer.getLatLngs()[0]);
            }
            return false;
        }

        function isPointInPath(point, polygon) {
            let inside = false;
            const x = point.lat, y = point.lng;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        // Close search results on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('visible');
            }
        });
    </script>
</body>
</html>
