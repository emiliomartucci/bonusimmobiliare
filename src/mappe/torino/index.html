<!DOCTYPE html>
<html lang="it">
<head>
    <script src="/js/head-common.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Zone OMI Torino - Canone Concordato 2025</title>
    <meta name="description" content="Trova la tua zona OMI a Torino e scopri quanto puoi affittare a canone concordato. Mappa interattiva con 47 zone OMI e valori €/mq aggiornati 2025.">
    <link rel="canonical" href="https://bonusimmobiliare.it/mappe/torino/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Mappa Zone OMI Torino - Canone Concordato 2025">
    <meta property="og:description" content="Trova la tua zona OMI a Torino e scopri quanto puoi affittare a canone concordato.">
    <meta property="og:url" content="https://bonusimmobiliare.it/mappe/torino/">
    <meta property="og:image" content="https://bonusimmobiliare.it/og-image.jpg">
    <meta property="og:site_name" content="Bonus Immobiliare">
    <meta property="og:locale" content="it_IT">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700;1,9..144,400;1,9..144,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400;1,8..60,500&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- ═══════════════════════════════════════════════════════════════
         TEMPLATE CONFIG - Modifica queste variabili per altre città
    ═══════════════════════════════════════════════════════════════ -->
    <script>
        const CITY_CONFIG = {
            name: 'Torino',
            slug: 'torino',
            geojsonPath: '/data/torino_omi_zones.geojson',
            zoneDataPath: '/data/torino-zone-omi.json',
            center: [45.0703, 7.6869],
            bounds: [[45.00, 7.55], [45.14, 7.78]],
            zoom: 12,
            dokicasaUrl: 'https://app.dokicasa.it/contratti/foglio-caratteristiche-immobile-torino/crea/default?utm_source=bonusimmobiliare&utm_medium=mappa&utm_campaign=torino',
            totalZones: 47,
            accordoYear: 2024,
            accordoDate: '15 aprile 2024'
        };
    </script>

    <!-- Shared Map CSS -->
    <link rel="stylesheet" href="/css/mappa.css">

    <!-- City-specific zone colors -->
    <style>
        :root {
            /* Zone Colors - Torino OMI zones */
            --zone-b: #E85D3B;  /* Centrale - Terracotta vivace */
            --zone-c: #F09B47;  /* Semicentrale - Arancio brillante */
            --zone-d: #E8C44A;  /* Periferica - Giallo oro */
            --zone-e: #6BAF7A;  /* Collina - Verde fresco */
        }
    </style>
    <!-- OLD INLINE STYLES REMOVED - Using /css/mappa.css instead -->
</head>
<body>
    <!-- Header Compatto -->
    <header class="header-bar">
        <a href="/" class="header-logo">
            <img src="/logo/logo_light_bg.svg" alt="Bonus Immobiliare">
        </a>
        <div class="header-title">
            <h1>Mappa Zone OMI <span id="city-name">Torino</span></h1>
        </div>
        <a href="/" class="header-back">
            <span>Torna al sito</span>
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
        </a>
    </header>

    <!-- Main Content: Map + Sidebar -->
    <div class="main-content">
        <!-- Map -->
        <div class="map-wrapper">
            <div id="map"></div>

            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="address-search" placeholder="Cerca indirizzo a Torino..." aria-label="Cerca indirizzo a Torino">
                </div>
                <div class="search-results" id="search-results"></div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Tipologia Zone</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-b);"></div> B - Centrale</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-c);"></div> C - Semicentrale</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-d);"></div> D - Periferica</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-e);"></div> E - Collina</div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Placeholder when no zone selected -->
            <div class="sidebar-placeholder" id="sidebar-placeholder">
                <svg class="sidebar-placeholder-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                </svg>
                <p>Clicca su una zona della mappa o cerca un indirizzo per vedere i dettagli del canone concordato.</p>
            </div>

            <!-- Content when zone selected -->
            <div class="sidebar-content" id="sidebar-content">
                <div class="sidebar-header">
                    <div class="sidebar-zona-row">
                        <span class="sidebar-zona-code" id="sidebar-code">B1</span>
                        <span class="sidebar-zona-type" id="sidebar-type">Centrale</span>
                    </div>
                    <div class="sidebar-zona-name" id="sidebar-name">Testaccio (Piazza S. Maria Liberatrice)</div>
                </div>

                <div class="sidebar-body">
                    <!-- Range -->
                    <div class="sidebar-range-section">
                        <div class="sidebar-range-label">Range Canone Concordato</div>
                        <div class="sidebar-range-value" id="sidebar-range">10,45 - 17,70</div>
                        <div class="sidebar-range-unit">euro/mq/mese</div>
                    </div>

                    <!-- Two column grid: Fasce + Esempi -->
                    <div class="sidebar-grid">
                        <!-- Fasce -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Fasce €/mq</div>
                            <div class="sidebar-fasce">
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">A (base)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-a">10,45-13,35</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">B (media)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-b">13,36-15,50</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">C (alta)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-c">15,51-17,70</span>
                                </div>
                            </div>
                        </div>

                        <!-- Esempi Affitto -->
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Esempi Mensili</div>
                            <div class="sidebar-examples">
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Camera<small>18mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-camera">188-319€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Bilocale<small>50mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-bilocale">523-885€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Trilocale<small>100mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-trilocale">1.045-1.770€</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Note (for rural zones) -->
                    <div class="sidebar-note-section" id="sidebar-note-section" style="display: none;">
                        <div class="sidebar-note" id="sidebar-note"></div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <a href="#" class="sidebar-cta" id="sidebar-cta" target="_blank" rel="noopener">
                        Calcola il Canone Esatto &rarr;
                    </a>
                </div>
            </div>
        </aside>
    </div>

    <!-- Footer Mini -->
    <footer class="footer-mini">
        <div class="footer-mini-text">
            Dati: <a href="https://www.agenziaentrate.gov.it/portale/web/guest/schede/fabbricatiterreni/omi/banche-dati/quotazioni-immobiliari" target="_blank" rel="noopener">Agenzia delle Entrate - OMI</a> |
            Valori: <a href="/blog/canone-concordato-torino/" rel="noopener">Accordo Territoriale Torino</a>
        </div>
        <div class="footer-mini-source">
            © 2025 Bonus Immobiliare
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script>
        // ═══════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════

        // Update page content from config
        document.getElementById('city-name').textContent = CITY_CONFIG.name;
        document.getElementById('address-search').placeholder = `Cerca indirizzo a ${CITY_CONFIG.name}...`;
        document.getElementById('sidebar-cta').href = CITY_CONFIG.dokicasaUrl;

        // Zone data storage
        let zoneData = {};

        // ═══════════════════════════════════════════════════════════════
        // COLORS AND UTILITIES
        // ═══════════════════════════════════════════════════════════════

        function getColor(codzona) {
            if (!codzona) return '#8B8178';
            const prefix = codzona.charAt(0).toUpperCase();
            const colors = {
                'B': getComputedStyle(document.documentElement).getPropertyValue('--zone-b').trim(),
                'C': getComputedStyle(document.documentElement).getPropertyValue('--zone-c').trim(),
                'D': getComputedStyle(document.documentElement).getPropertyValue('--zone-d').trim(),
                'E': getComputedStyle(document.documentElement).getPropertyValue('--zone-e').trim()
            };
            return colors[prefix] || '#8B8178';
        }

        function getTipoZona(codzona) {
            if (!codzona) return 'Non classificata';
            const prefix = codzona.charAt(0).toUpperCase();
            const types = {
                'B': 'Centrale',
                'C': 'Semicentrale',
                'D': 'Periferica',
                'E': 'Collina'
            };
            return types[prefix] || 'Altra';
        }

        function formatPrice(value) {
            if (value === null || value === undefined) return 'N/D';
            return value.toFixed(2).replace('.', ',');
        }

        // Convert UPPERCASE to Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/(?:^|\s|[-(])\w/g, function(match) {
                return match.toUpperCase();
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // MAP SETUP
        // ═══════════════════════════════════════════════════════════════

        const torinoBounds = L.latLngBounds(CITY_CONFIG.bounds[0], CITY_CONFIG.bounds[1]);

        const map = L.map('map', {
            center: CITY_CONFIG.center,
            zoom: CITY_CONFIG.zoom,
            minZoom: 10,
            maxZoom: 18,
            maxBounds: torinoBounds,
            maxBoundsViscosity: 1.0
        });

        // Close tooltips during drag to prevent accumulation
        map.on('dragstart', function() {
            map.eachLayer(function(layer) {
                if (layer.getTooltip && layer.getTooltip()) {
                    layer.closeTooltip();
                }
            });
        });

        // CartoDB Positron - clean, editorial look
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // ═══════════════════════════════════════════════════════════════
        // GEOJSON LAYER
        // ═══════════════════════════════════════════════════════════════

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.CODZONA),
                weight: 1,
                opacity: 1,
                color: 'rgba(255,255,255,0.8)',
                fillOpacity: 0.55
            };
        }

        let lastHighlighted = null;
        let geojsonLayer;
        let addressMarker = null;

        function closeAllTooltips() {
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    layer.closeTooltip();
                });
            }
        }

        function highlightFeature(e) {
            // Close all tooltips first to prevent accumulation
            closeAllTooltips();

            if (lastHighlighted && lastHighlighted !== e.target) {
                geojsonLayer.resetStyle(lastHighlighted);
            }
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#2A3223',
                fillOpacity: 0.8
            });
            layer.bringToFront();
            lastHighlighted = layer;
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            if (lastHighlighted === e.target) {
                lastHighlighted = null;
            }
        }

        function showSidebar(codzona) {
            const placeholder = document.getElementById('sidebar-placeholder');
            const content = document.getElementById('sidebar-content');
            const data = zoneData[codzona];

            if (!data) {
                placeholder.style.display = 'flex';
                content.classList.remove('visible');
                return;
            }

            // Hide placeholder, show content
            placeholder.style.display = 'none';
            content.classList.add('visible');

            // Update sidebar content
            document.getElementById('sidebar-code').textContent = codzona;
            document.getElementById('sidebar-type').textContent = getTipoZona(codzona);
            document.getElementById('sidebar-type').style.background = getColor(codzona);
            document.getElementById('sidebar-name').textContent = toTitleCase(data.nome || '');

            // Range
            if (data.min !== null && data.max !== null) {
                document.getElementById('sidebar-range').textContent = `${formatPrice(data.min)} - ${formatPrice(data.max)}`;

                // Calcola esempi affitto
                const cameraMin = Math.round(data.min * 18);
                const cameraMax = Math.round(data.max * 18);
                const bilocaleMin = Math.round(data.min * 50);
                const bilocaleMax = Math.round(data.max * 50);
                const trilocaleMin = Math.round(data.min * 100);
                const trilocaleMax = Math.round(data.max * 100);

                document.getElementById('sidebar-ex-camera').textContent = `${cameraMin.toLocaleString('it')} - ${cameraMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-bilocale').textContent = `${bilocaleMin.toLocaleString('it')} - ${bilocaleMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-trilocale').textContent = `${trilocaleMin.toLocaleString('it')} - ${trilocaleMax.toLocaleString('it')} €`;
            } else {
                document.getElementById('sidebar-range').textContent = 'N/D';
                document.getElementById('sidebar-ex-camera').textContent = 'N/D';
                document.getElementById('sidebar-ex-bilocale').textContent = 'N/D';
                document.getElementById('sidebar-ex-trilocale').textContent = 'N/D';
            }

            // Fasce (compact format)
            if (data.fasce) {
                document.getElementById('sidebar-fascia-a').textContent = data.fasce.A ?
                    `${formatPrice(data.fasce.A.min)}-${formatPrice(data.fasce.A.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-b').textContent = data.fasce.B ?
                    `${formatPrice(data.fasce.B.min)}-${formatPrice(data.fasce.B.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-c').textContent = data.fasce.C ?
                    `${formatPrice(data.fasce.C.min)}-${formatPrice(data.fasce.C.max)}` : 'N/D';
            }

            // Note (for rural zones)
            const noteSection = document.getElementById('sidebar-note-section');
            const noteEl = document.getElementById('sidebar-note');
            if (data.note) {
                noteEl.textContent = data.note;
                noteSection.style.display = 'block';
            } else {
                noteSection.style.display = 'none';
            }
        }

        function onEachFeature(feature, layer) {
            // Bind minimal tooltip
            const codzona = feature.properties.CODZONA;
            if (codzona) {
                layer.bindTooltip(codzona, {
                    permanent: false,
                    direction: 'center',
                    className: 'zone-tooltip'
                });
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    showSidebar(codzona);
                }
            });
        }

        // Load zone data first, then GeoJSON
        fetch(CITY_CONFIG.zoneDataPath)
            .then(response => response.json())
            .then(data => {
                zoneData = data;
                return fetch(CITY_CONFIG.geojsonPath);
            })
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                const bounds = geojsonLayer.getBounds();
                map.fitBounds(bounds);
                map.setMaxBounds(bounds.pad(0.1));
            })
            .catch(err => {
                console.error('Errore caricamento dati:', err);
            });

        // ═══════════════════════════════════════════════════════════════
        // ADDRESS SEARCH (Nominatim Geocoding)
        // ═══════════════════════════════════════════════════════════════

        const addressInput = document.getElementById('address-search');
        const searchResults = document.getElementById('search-results');
        let searchTimeout = null;

        addressInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query.length < 3) {
                searchResults.classList.remove('visible');
                return;
            }

            searchTimeout = setTimeout(() => searchAddress(query), 400);
        });

        async function searchAddress(query) {
            searchResults.innerHTML = '<div class="search-loading">Ricerca in corso...</div>';
            searchResults.classList.add('visible');

            try {

                const viewbox = `${CITY_CONFIG.bounds[0][1]},${CITY_CONFIG.bounds[1][0]},${CITY_CONFIG.bounds[1][1]},${CITY_CONFIG.bounds[0][0]}`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', ' + CITY_CONFIG.name + ', Italia')}&limit=5&addressdetails=1&viewbox=${viewbox}&bounded=1`;

                const response = await fetch(url, {
                    headers: { 'Accept-Language': 'it' }
                });
                const results = await response.json();

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-loading">Nessun risultato trovato</div>';
                    return;
                }

                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lon="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');

                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        goToAddress(parseFloat(this.dataset.lat), parseFloat(this.dataset.lon), this.textContent.trim());
                    });
                });
            } catch (err) {
                searchResults.innerHTML = '<div class="search-loading">Errore nella ricerca. Riprova tra qualche secondo.</div>';
            }
        }

        function goToAddress(lat, lon, name) {
            if (addressMarker) map.removeLayer(addressMarker);

            const markerIcon = L.divIcon({
                className: 'address-marker',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });

            addressMarker = L.marker([lat, lon], { icon: markerIcon })
                .addTo(map);

            map.setView([lat, lon], 16);

            // Find containing zone
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.getBounds && layer.getBounds().contains([lat, lon])) {
                        const point = L.latLng(lat, lon);
                        if (isPointInPolygon(point, layer)) {
                            highlightFeature({ target: layer });
                            const props = layer.feature.properties;
                            showSidebar(props.CODZONA);
                        }
                    }
                });
            }

            searchResults.classList.remove('visible');
            addressInput.value = '';
        }

        function isPointInPolygon(point, layer) {
            if (layer.feature.geometry.type === 'Polygon') {
                return isPointInPath(point, layer.getLatLngs()[0]);
            }
            return false;
        }

        function isPointInPath(point, polygon) {
            let inside = false;
            const x = point.lat, y = point.lng;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        // Close search results on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('visible');
            }
        });
    </script>
</body>
</html>
