<!DOCTYPE html>
<html lang="it">
<head>
    <script src="/js/head-common.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Zone Canone Concordato Milano 2025 | Bonus Immobiliare</title>
    <meta name="description" content="Trova la tua zona a Milano e scopri quanto puoi affittare a canone concordato. Mappa interattiva con 5 zone omogenee e valori €/mq aggiornati 2025.">
    <link rel="canonical" href="https://bonusimmobiliare.it/mappe/milano/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Mappa Zone Canone Concordato Milano 2025">
    <meta property="og:description" content="Trova la tua zona a Milano e scopri quanto puoi affittare a canone concordato.">
    <meta property="og:url" content="https://bonusimmobiliare.it/mappe/milano/">
    <meta property="og:image" content="https://bonusimmobiliare.it/og-image.jpg">
    <meta property="og:site_name" content="Bonus Immobiliare">
    <meta property="og:locale" content="it_IT">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700;1,9..144,400;1,9..144,500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,400;1,8..60,500&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Shared Map CSS -->
    <link rel="stylesheet" href="/css/mappa.css">

    <!-- City-specific zone colors -->
    <style>
        :root {
            /* Zone Colors - Milano 5 zone */
            --zone-1: #E85D3B;  /* Centro - Terracotta */
            --zone-2: #F09B47;  /* Semicentro - Arancio */
            --zone-3: #E8C44A;  /* Periferia Consolidata - Giallo */
            --zone-4: #6BAF7A;  /* Periferia - Verde */
            --zone-5: #7BA08A;  /* Periferia Esterna - Verde salvia */
        }
    </style>

    <script>
        const CITY_CONFIG = {
            name: 'Milano',
            slug: 'milano',
            geojsonPath: '/data/milano_concordato_zones.geojson',
            zoneDataPath: '/data/milano-zone-concordato.json',
            center: [45.4642, 9.1900],
            bounds: [[45.39, 9.04], [45.54, 9.28]],
            zoom: 12,
            dokicasaUrl: 'https://app.dokicasa.it/contratti/foglio-caratteristiche-immobile-milano/crea/default?utm_source=bonusimmobiliare&utm_medium=mappa&utm_campaign=milano',
            totalZones: 5,
            accordoYear: 2023,
            accordoDate: '27 luglio 2023',
            // Milano usa campo 'zona' invece di 'CODZONA'
            zoneField: 'zona'
        };
    </script>

</head>
<body>
    <header class="header-bar">
        <a href="/" class="header-logo">
            <img src="/logo/logo_light_bg.svg" alt="Bonus Immobiliare">
        </a>
        <div class="header-title">
            <h1>Mappa Canone Concordato <span>Milano</span></h1>
        </div>
        <a href="/" class="header-back">
            <span>Torna al sito</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
        </a>
    </header>

    <div class="main-content">
        <div class="map-wrapper">
            <div id="map"></div>

            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="address-search" placeholder="Cerca indirizzo a Milano...">
                </div>
                <div class="search-results" id="search-results"></div>
            </div>

            <div class="legend">
                <div class="legend-title">Zone Concordato</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-1);"></div> Zona 1 - Centro</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-2);"></div> Zona 2 - Semicentro</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-3);"></div> Zona 3 - Periferia Consolidata</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-4);"></div> Zona 4 - Periferia</div>
                <div class="legend-item"><div class="legend-color" style="background: var(--zone-5);"></div> Zona 5 - Periferia Esterna</div>
            </div>
        </div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-placeholder" id="sidebar-placeholder">
                <svg class="sidebar-placeholder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                </svg>
                <p>Clicca su una zona della mappa o cerca un indirizzo per vedere i dettagli del canone concordato.</p>
            </div>

            <div class="sidebar-content" id="sidebar-content">
                <div class="sidebar-header">
                    <div class="sidebar-zona-row">
                        <span class="sidebar-zona-code" id="sidebar-code">Zona 1</span>
                        <span class="sidebar-zona-type" id="sidebar-type">Centro</span>
                    </div>
                    <div class="sidebar-zona-name" id="sidebar-name">Centro Storico</div>
                </div>

                <div class="sidebar-body">
                    <div class="sidebar-range-section">
                        <div class="sidebar-range-label">Range Canone Concordato</div>
                        <div class="sidebar-range-value" id="sidebar-range">8,33 - 25,83</div>
                        <div class="sidebar-range-unit">euro/mq/mese</div>
                    </div>

                    <div class="sidebar-grid">
                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Fasce €/mq</div>
                            <div class="sidebar-fasce">
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">A (base)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-a">8,33-14,17</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">B (media)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-b">14,25-20,00</span>
                                </div>
                                <div class="sidebar-fascia-row">
                                    <span class="sidebar-fascia-label">C (alta)</span>
                                    <span class="sidebar-fascia-value" id="sidebar-fascia-c">20,08-25,83</span>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-section-title">Esempi Mensili</div>
                            <div class="sidebar-examples">
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Bilocale<small>50mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-bilocale">417-1.292€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Trilocale<small>80mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-trilocale">667-2.067€</span>
                                </div>
                                <div class="sidebar-example">
                                    <span class="sidebar-example-label">Quadrilocale<small>120mq</small></span>
                                    <span class="sidebar-example-value" id="sidebar-ex-quadrilocale">1.000-3.100€</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-stanza-section" id="sidebar-stanza-section" style="display: none;">
                        <div class="sidebar-stanza-label">Canone max stanza singola (studenti)</div>
                        <div class="sidebar-stanza-value" id="sidebar-stanza">600 €/mese</div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <a href="#" class="sidebar-cta" id="sidebar-cta" target="_blank" rel="noopener">
                        Calcola il Canone Esatto &rarr;
                    </a>
                </div>
            </div>
        </aside>
    </div>

    <footer class="footer-mini">
        <div class="footer-mini-text">
            Dati: <a href="https://gisportal.comune.milano.it" target="_blank" rel="noopener">Comune di Milano - GIS Portal</a> |
            Valori: <a href="https://www.comune.milano.it/servizi/canone-concordato" target="_blank" rel="noopener">Accordo Territoriale Milano 2023</a>
        </div>
        <div class="footer-mini-source">
            &copy; 2025 Bonus Immobiliare
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.getElementById('sidebar-cta').href = CITY_CONFIG.dokicasaUrl;

        let zoneData = {};

        function getColor(zona) {
            const colors = {
                '1': getComputedStyle(document.documentElement).getPropertyValue('--zone-1').trim(),
                '2': getComputedStyle(document.documentElement).getPropertyValue('--zone-2').trim(),
                '3': getComputedStyle(document.documentElement).getPropertyValue('--zone-3').trim(),
                '4': getComputedStyle(document.documentElement).getPropertyValue('--zone-4').trim(),
                '5': getComputedStyle(document.documentElement).getPropertyValue('--zone-5').trim()
            };
            return colors[zona] || '#8B8178';
        }

        function getTipoZona(zona) {
            const types = {
                '1': 'Centro',
                '2': 'Semicentro',
                '3': 'Periferia Consolidata',
                '4': 'Periferia',
                '5': 'Periferia Esterna'
            };
            return types[zona] || 'Altra';
        }

        function formatPrice(value) {
            if (value === null || value === undefined) return 'N/D';
            return value.toFixed(2).replace('.', ',');
        }

        const cityBounds = L.latLngBounds(CITY_CONFIG.bounds[0], CITY_CONFIG.bounds[1]);

        const map = L.map('map', {
            center: CITY_CONFIG.center,
            zoom: CITY_CONFIG.zoom,
            minZoom: 10,
            maxZoom: 18,
            maxBounds: cityBounds,
            maxBoundsViscosity: 1.0
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.zona),
                weight: 1,
                opacity: 1,
                color: 'rgba(255,255,255,0.8)',
                fillOpacity: 0.55
            };
        }

        let lastHighlighted = null;
        let geojsonLayer;
        let addressMarker = null;

        function highlightFeature(e) {
            if (lastHighlighted && lastHighlighted !== e.target) {
                geojsonLayer.resetStyle(lastHighlighted);
            }
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#2A3223',
                fillOpacity: 0.8
            });
            layer.bringToFront();
            lastHighlighted = layer;
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            if (lastHighlighted === e.target) {
                lastHighlighted = null;
            }
        }

        function showSidebar(zona) {
            const placeholder = document.getElementById('sidebar-placeholder');
            const content = document.getElementById('sidebar-content');
            const data = zoneData[zona];

            if (!data) {
                placeholder.style.display = 'flex';
                content.classList.remove('visible');
                return;
            }

            placeholder.style.display = 'none';
            content.classList.add('visible');

            document.getElementById('sidebar-code').textContent = 'Zona ' + zona;
            document.getElementById('sidebar-type').textContent = getTipoZona(zona);
            document.getElementById('sidebar-type').style.background = getColor(zona);
            document.getElementById('sidebar-name').textContent = data.nome || '';

            if (data.min !== null && data.max !== null) {
                document.getElementById('sidebar-range').textContent = `${formatPrice(data.min)} - ${formatPrice(data.max)}`;

                const bilocaleMin = Math.round(data.min * 50);
                const bilocaleMax = Math.round(data.max * 50);
                const trilocaleMin = Math.round(data.min * 80);
                const trilocaleMax = Math.round(data.max * 80);
                const quadrilocaleMin = Math.round(data.min * 120);
                const quadrilocaleMax = Math.round(data.max * 120);

                document.getElementById('sidebar-ex-bilocale').textContent = `${bilocaleMin.toLocaleString('it')} - ${bilocaleMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-trilocale').textContent = `${trilocaleMin.toLocaleString('it')} - ${trilocaleMax.toLocaleString('it')} €`;
                document.getElementById('sidebar-ex-quadrilocale').textContent = `${quadrilocaleMin.toLocaleString('it')} - ${quadrilocaleMax.toLocaleString('it')} €`;
            }

            if (data.fasce) {
                document.getElementById('sidebar-fascia-a').textContent = data.fasce.A ?
                    `${formatPrice(data.fasce.A.min)}-${formatPrice(data.fasce.A.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-b').textContent = data.fasce.B ?
                    `${formatPrice(data.fasce.B.min)}-${formatPrice(data.fasce.B.max)}` : 'N/D';
                document.getElementById('sidebar-fascia-c').textContent = data.fasce.C ?
                    `${formatPrice(data.fasce.C.min)}-${formatPrice(data.fasce.C.max)}` : 'N/D';
            }

            const stanzaSection = document.getElementById('sidebar-stanza-section');
            if (data.stanza) {
                document.getElementById('sidebar-stanza').textContent = data.stanza + ' €/mese';
                stanzaSection.style.display = 'block';
            } else {
                stanzaSection.style.display = 'none';
            }
        }

        function onEachFeature(feature, layer) {
            const zona = feature.properties.zona;
            if (zona) {
                layer.bindTooltip('Zona ' + zona, {
                    permanent: false,
                    direction: 'center',
                    className: 'zone-tooltip'
                });
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    showSidebar(zona);
                }
            });
        }

        fetch(CITY_CONFIG.zoneDataPath)
            .then(response => response.json())
            .then(data => {
                zoneData = data;
                return fetch(CITY_CONFIG.geojsonPath);
            })
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                const bounds = geojsonLayer.getBounds();
                map.fitBounds(bounds);
                map.setMaxBounds(bounds.pad(0.1));
            })
            .catch(err => {
                console.error('Errore caricamento dati:', err);
            });

        // Address Search
        const addressInput = document.getElementById('address-search');
        const searchResults = document.getElementById('search-results');
        let searchTimeout = null;
        let lastSearchTime = 0;
        const RATE_LIMIT_MS = 10000;

        addressInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query.length < 3) {
                searchResults.classList.remove('visible');
                return;
            }

            const now = Date.now();
            const timeSinceLastSearch = now - lastSearchTime;

            if (timeSinceLastSearch < RATE_LIMIT_MS && lastSearchTime > 0) {
                const waitSeconds = Math.ceil((RATE_LIMIT_MS - timeSinceLastSearch) / 1000);
                searchResults.innerHTML = `<div class="search-loading search-rate-limit">Attendi ${waitSeconds} secondi</div>`;
                searchResults.classList.add('visible');
                searchTimeout = setTimeout(() => searchAddress(query), RATE_LIMIT_MS - timeSinceLastSearch + 100);
                return;
            }

            searchTimeout = setTimeout(() => searchAddress(query), 400);
        });

        async function searchAddress(query) {
            const now = Date.now();
            const timeSinceLastSearch = now - lastSearchTime;

            if (timeSinceLastSearch < RATE_LIMIT_MS && lastSearchTime > 0) {
                const waitSeconds = Math.ceil((RATE_LIMIT_MS - timeSinceLastSearch) / 1000);
                searchResults.innerHTML = `<div class="search-loading search-rate-limit">Attendi ${waitSeconds} secondi</div>`;
                searchResults.classList.add('visible');
                return;
            }

            searchResults.innerHTML = '<div class="search-loading">Ricerca in corso...</div>';
            searchResults.classList.add('visible');

            try {
                lastSearchTime = Date.now();

                const viewbox = `${CITY_CONFIG.bounds[0][1]},${CITY_CONFIG.bounds[1][0]},${CITY_CONFIG.bounds[1][1]},${CITY_CONFIG.bounds[0][0]}`;
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Milano, Italia')}&limit=5&addressdetails=1&viewbox=${viewbox}&bounded=1`;

                const response = await fetch(url, {
                    headers: { 'Accept-Language': 'it' }
                });
                const results = await response.json();

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-loading">Nessun risultato trovato</div>';
                    return;
                }

                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lon="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');

                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        goToAddress(parseFloat(this.dataset.lat), parseFloat(this.dataset.lon), this.textContent.trim());
                    });
                });
            } catch (err) {
                searchResults.innerHTML = '<div class="search-loading">Errore nella ricerca. Riprova.</div>';
            }
        }

        function goToAddress(lat, lon, name) {
            if (addressMarker) map.removeLayer(addressMarker);

            const markerIcon = L.divIcon({
                className: 'address-marker',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });

            addressMarker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);
            map.setView([lat, lon], 14);

            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.getBounds && layer.getBounds().contains([lat, lon])) {
                        const point = L.latLng(lat, lon);
                        if (isPointInPolygon(point, layer)) {
                            highlightFeature({ target: layer });
                            const props = layer.feature.properties;
                            showSidebar(props.zona);
                        }
                    }
                });
            }

            searchResults.classList.remove('visible');
            addressInput.value = '';
        }

        function isPointInPolygon(point, layer) {
            if (layer.feature.geometry.type === 'Polygon') {
                return isPointInPath(point, layer.getLatLngs()[0]);
            } else if (layer.feature.geometry.type === 'MultiPolygon') {
                const latLngs = layer.getLatLngs();
                for (let i = 0; i < latLngs.length; i++) {
                    if (isPointInPath(point, latLngs[i][0])) {
                        return true;
                    }
                }
            }
            return false;
        }

        function isPointInPath(point, polygon) {
            let inside = false;
            const x = point.lat, y = point.lng;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('visible');
            }
        });
    </script>
</body>
</html>
