<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone OMI Roma - Canone Concordato</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        .info-panel h2 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }
        .info-panel p {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        .zone-count {
            display: inline-block;
            background: #3388ff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Popup styling */
        .leaflet-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-width: 200px;
        }
        .popup-header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 12px 15px;
            margin: -13px -20px 12px -20px;
            border-radius: 12px 12px 0 0;
        }
        .popup-zona {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .popup-tipo {
            font-size: 12px;
            opacity: 0.9;
        }
        .popup-body {
            padding: 0 5px;
        }
        .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .popup-row:last-child {
            border-bottom: none;
        }
        .popup-label {
            color: #666;
        }
        .popup-value {
            font-weight: 600;
            color: #333;
        }

        /* Search box */
        .search-container {
            position: absolute;
            top: 10px;
            left: 60px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            padding: 12px 15px 12px 40px;
            font-size: 14px;
            border: none;
            border-radius: 25px;
            width: 320px;
            outline: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            transition: box-shadow 0.2s;
        }
        .search-box input:focus {
            box-shadow: 0 2px 15px rgba(0,0,0,0.25);
        }
        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .search-results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .search-results.visible {
            display: block;
        }
        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            transition: background 0.15s;
        }
        .search-result-item:hover {
            background: #f5f5f5;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-loading {
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        /* Zone search */
        .zone-search {
            position: relative;
        }
        .zone-search input {
            padding: 10px 15px 10px 35px;
            font-size: 13px;
            border: none;
            border-radius: 20px;
            width: 180px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }
        .zone-search::before {
            content: "#";
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: #999;
            font-weight: 600;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 14px;
            margin-right: 8px;
            border-radius: 3px;
        }

        /* Address marker */
        .address-marker {
            background: #e74c3c;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>


    <div class="search-container">
        <div class="search-box">
            <input type="text" id="address-search" placeholder="Cerca indirizzo a Roma...">
        </div>
        <div class="search-results" id="search-results"></div>
        <div class="zone-search">
            <input type="text" id="zone-search" placeholder="Zona (es. D8)">
        </div>
    </div>

    <div class="legend">
        <div class="legend-title">Tipologia Zone</div>
        <div class="legend-item"><div class="legend-color" style="background: #e74c3c;"></div> B - Centrale</div>
        <div class="legend-item"><div class="legend-color" style="background: #e67e22;"></div> C - Semicentrale</div>
        <div class="legend-item"><div class="legend-color" style="background: #f1c40f;"></div> D - Periferica</div>
        <div class="legend-item"><div class="legend-color" style="background: #2ecc71;"></div> E - Suburbana</div>
        <div class="legend-item"><div class="legend-color" style="background: #3498db;"></div> R - Rurale</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Bounds di Roma (le zone OMI)
        const romaBounds = L.latLngBounds(
            [41.655, 12.035],  // Sud-Ovest
            [42.145, 12.855]   // Nord-Est
        );

        // Inizializza mappa con limiti
        const map = L.map('map', {
            center: [41.9028, 12.4964],
            zoom: 11,
            minZoom: 10,
            maxZoom: 18,
            maxBounds: romaBounds,
            maxBoundsViscosity: 1.0  // Impedisce completamente di uscire dai bounds
        });

        // Tile layer OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors | Dati OMI: Agenzia delle Entrate'
        }).addTo(map);

        // Colori per tipo di zona
        function getColor(codzona) {
            if (!codzona) return '#95a5a6';
            const prefix = codzona.charAt(0).toUpperCase();
            switch(prefix) {
                case 'B': return '#e74c3c';
                case 'C': return '#e67e22';
                case 'D': return '#f1c40f';
                case 'E': return '#2ecc71';
                case 'R': return '#3498db';
                default: return '#95a5a6';
            }
        }

        function getTipoZona(codzona) {
            if (!codzona) return 'Non classificata';
            const prefix = codzona.charAt(0).toUpperCase();
            switch(prefix) {
                case 'B': return 'Centrale';
                case 'C': return 'Semicentrale';
                case 'D': return 'Periferica';
                case 'E': return 'Suburbana';
                case 'R': return 'Rurale';
                default: return 'Altra';
            }
        }

        function getHeaderColor(codzona) {
            if (!codzona) return 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
            const prefix = codzona.charAt(0).toUpperCase();
            switch(prefix) {
                case 'B': return 'linear-gradient(135deg, #e74c3c, #c0392b)';
                case 'C': return 'linear-gradient(135deg, #e67e22, #d35400)';
                case 'D': return 'linear-gradient(135deg, #f1c40f, #f39c12)';
                case 'E': return 'linear-gradient(135deg, #2ecc71, #27ae60)';
                case 'R': return 'linear-gradient(135deg, #3498db, #2980b9)';
                default: return 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
            }
        }

        // Stile per ogni feature
        function style(feature) {
            return {
                fillColor: getColor(feature.properties.CODZONA),
                weight: 1,
                opacity: 1,
                color: '#fff',
                fillOpacity: 0.6
            };
        }

        // Highlight on hover - traccia ultima zona per evitare bug
        let lastHighlighted = null;

        function highlightFeature(e) {
            // Reset previous highlighted zone
            if (lastHighlighted && lastHighlighted !== e.target) {
                geojsonLayer.resetStyle(lastHighlighted);
            }

            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#333',
                fillOpacity: 0.8
            });
            layer.bringToFront();
            lastHighlighted = layer;
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
            if (lastHighlighted === e.target) {
                lastHighlighted = null;
            }
        }

        // Crea contenuto popup (personalizzabile)
        function createPopupContent(props) {
            const codzona = props.CODZONA || 'N/A';
            const tipoZona = getTipoZona(codzona);
            const headerColor = getHeaderColor(codzona);

            // PERSONALIZZA QUI IL CONTENUTO DEL POPUP
            return `
                <div class="popup-header" style="background: ${headerColor};">
                    <div class="popup-zona">${codzona}</div>
                    <div class="popup-tipo">${tipoZona}</div>
                </div>
                <div class="popup-body">
                    <div class="popup-row">
                        <span class="popup-label">Comune</span>
                        <span class="popup-value">Roma</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Codice</span>
                        <span class="popup-value">${props.CODCOM}</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Periodo</span>
                        <span class="popup-value">2025 / 1¬∞ Sem.</span>
                    </div>
                </div>
            `;
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    const popup = L.popup({
                        maxWidth: 280,
                        className: 'custom-popup'
                    })
                    .setLatLng(e.latlng)
                    .setContent(createPopupContent(feature.properties))
                    .openOn(map);
                }
            });
        }

        // Variabile globale per il layer
        let geojsonLayer;
        let addressMarker = null;

        // Carica GeoJSON
        fetch('roma_omi_zones.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Fit bounds alle zone
                const bounds = geojsonLayer.getBounds();
                map.fitBounds(bounds);

                // Aggiorna i bounds max per essere esattamente le zone + padding
                const paddedBounds = bounds.pad(0.1);
                map.setMaxBounds(paddedBounds);
            })
            .catch(err => {
                console.error('Errore caricamento GeoJSON:', err);
            });

        // ==========================================
        // GEOCODING - Ricerca indirizzi
        // ==========================================
        const addressInput = document.getElementById('address-search');
        const searchResults = document.getElementById('search-results');
        let searchTimeout = null;

        addressInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();

            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query.length < 3) {
                searchResults.classList.remove('visible');
                return;
            }

            // Debounce: aspetta 300ms prima di cercare
            searchTimeout = setTimeout(() => {
                searchAddress(query);
            }, 300);
        });

        async function searchAddress(query) {
            searchResults.innerHTML = '<div class="search-loading">Ricerca in corso...</div>';
            searchResults.classList.add('visible');

            try {
                // Nominatim API (OpenStreetMap) - limita a Roma
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Roma, Italia')}&limit=5&addressdetails=1&viewbox=12.035,42.145,12.855,41.655&bounded=1`;

                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'it'
                    }
                });
                const results = await response.json();

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-loading">Nessun risultato trovato</div>';
                    return;
                }

                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" data-lat="${r.lat}" data-lon="${r.lon}">
                        ${r.display_name}
                    </div>
                `).join('');

                // Click sui risultati
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const lat = parseFloat(this.dataset.lat);
                        const lon = parseFloat(this.dataset.lon);
                        goToAddress(lat, lon, this.textContent.trim());
                    });
                });

            } catch (err) {
                searchResults.innerHTML = '<div class="search-loading">Errore nella ricerca</div>';
            }
        }

        function goToAddress(lat, lon, name) {
            // Rimuovi marker precedente
            if (addressMarker) {
                map.removeLayer(addressMarker);
            }

            // Crea nuovo marker
            const markerIcon = L.divIcon({
                className: 'address-marker',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            addressMarker = L.marker([lat, lon], { icon: markerIcon })
                .addTo(map)
                .bindPopup(`<strong>${name}</strong>`)
                .openPopup();

            // Zoom sulla posizione
            map.setView([lat, lon], 16);

            // Trova la zona OMI contenente questo punto
            if (geojsonLayer) {
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.getBounds && layer.getBounds().contains([lat, lon])) {
                        // Verifica se il punto √® dentro il poligono
                        const point = L.latLng(lat, lon);
                        if (isPointInPolygon(point, layer)) {
                            highlightFeature({ target: layer });
                            setTimeout(() => {
                                const props = layer.feature.properties;
                                addressMarker.setPopupContent(`
                                    <strong>${name}</strong><br>
                                    <span style="color: #666;">Zona OMI: <strong>${props.CODZONA}</strong></span>
                                `);
                                addressMarker.openPopup();
                            }, 100);
                        }
                    }
                });
            }

            // Nascondi risultati
            searchResults.classList.remove('visible');
            addressInput.value = '';
        }

        // Verifica se un punto √® dentro un poligono
        function isPointInPolygon(point, layer) {
            if (layer.feature.geometry.type === 'Polygon') {
                const poly = layer.getLatLngs()[0];
                return isPointInPath(point, poly);
            }
            return false;
        }

        function isPointInPath(point, polygon) {
            let inside = false;
            const x = point.lat, y = point.lng;

            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;

                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        // Chiudi risultati cliccando fuori
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('visible');
            }
        });

        // ==========================================
        // RICERCA ZONE
        // ==========================================
        const zoneInput = document.getElementById('zone-search');

        zoneInput.addEventListener('input', function(e) {
            const searchValue = e.target.value.toUpperCase().trim();

            if (!geojsonLayer) return;

            geojsonLayer.eachLayer(function(layer) {
                const codzona = layer.feature.properties.CODZONA;
                if (codzona && codzona.toUpperCase().includes(searchValue)) {
                    layer.setStyle({ fillOpacity: 0.9, weight: 2 });
                    if (searchValue === codzona.toUpperCase()) {
                        map.fitBounds(layer.getBounds(), { maxZoom: 14 });

                        // Apri popup
                        const center = layer.getBounds().getCenter();
                        L.popup({
                            maxWidth: 280
                        })
                        .setLatLng(center)
                        .setContent(createPopupContent(layer.feature.properties))
                        .openOn(map);
                    }
                } else if (searchValue) {
                    layer.setStyle({ fillOpacity: 0.1, weight: 0.5 });
                } else {
                    geojsonLayer.resetStyle(layer);
                }
            });
        });
    </script>
</body>
</html>
